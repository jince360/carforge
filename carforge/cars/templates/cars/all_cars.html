{% extends "base.html" %}
{% block content %}
{% load humanize %}
<main class="flex-grow flex flex-col w-full pt-28 pb-12">
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-primary/5 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-primary/5 rounded-full blur-[100px]"></div>
    </div>
    <div class="relative z-10 max-w-7xl mx-auto px-6 lg:px-12 w-full">
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-16 gap-6">
            <div>
                <span class="text-primary text-[10px] font-black tracking-[0.4em] uppercase mb-2 block">Our
                    Collection</span>
                <h1 class="text-white text-3xl lg:text-4xl font-bold uppercase tracking-tight">All Vehicles</h1>
            </div>
            <div class="text-right">
                <p class="text-white/40 text-xs font-medium uppercase tracking-widest">
                    Page {{ all_cars.number }} of {{ all_cars.paginator.num_pages }}
                    ({{ all_cars.paginator.count }} Vehicles)
                </p>
            </div>
        </div>
        <div class="glass-panel p-6 rounded-2xl mb-12 border border-white/10">
            <form method="GET" action="" class="flex flex-col gap-6">
                <div class="flex items-center justify-between flex-wrap gap-4 border-b border-white/5 pb-4 mb-2">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">tune</span>
                        <span class="text-white font-bold uppercase tracking-wider text-sm">Smart Filters</span>
                    </div>

                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="relative">
                        <select
                            class="w-full bg-background-dark/50 border border-white/10 rounded-lg py-2.5 px-4 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary appearance-none cursor-pointer"
                            name="brand">
                            <option value="">Brand (All)</option>
                            {% for i in brand %}
                            <option value="{{i.brand__name}}" {% if i.brand__name == brand_search %}selected{% endif %}>{{i.brand__name}}</option>
                            {% endfor %}


                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/50">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                    <div class="relative">
                        <select name="model"
                            class="w-full bg-background-dark/50 border border-white/10 rounded-lg py-2.5 px-4 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary appearance-none cursor-pointer">
                            <option value="">Model (All)</option>
                            {% for i in model %}
                            <option value="{{i.model}}" {% if i.model == model_search %}selected{% endif %}>{{i.model}}</option>
                            {% endfor %}

                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/50">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                    <div class="relative">
                        <select name="year"
                            class="w-full bg-background-dark/50 border border-white/10 rounded-lg py-2.5 px-4 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary appearance-none cursor-pointer">
                            <option value="">Year (Any)</option>
                            {% for i in year %}
                            <option value="{{ i.year }}" {% if i.year|stringformat:"s" == year_search %}selected{% endif %}>{{ i.year }}</option>
                            {% endfor %}
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/50">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                    <div class="relative">
                        <select name="transmission"
                            class="w-full bg-background-dark/50 border border-white/10 rounded-lg py-2.5 px-4 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary appearance-none cursor-pointer">
                            <option value="">Transmission (All)</option>
                            {% for i in transmission %}
                            <option value="{{i.transmission}}" {% if i.transmission == transmission_search %}selected{% endif %}>{{i.get_transmission_display}}</option>
                            {% endfor %}
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/50">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                    <div class="relative">
                        <select name="fuel"
                            class="w-full bg-background-dark/50 border border-white/10 rounded-lg py-2.5 px-4 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary appearance-none cursor-pointer">
                            <option value="">Fuel Type (All)</option>
                            {% for i in fuel %}
                            <option value="{{i.fuel}}" {% if i.fuel == fuel_search %}selected{% endif %}>{{i.get_fuel_display}}</option>
                            {% endfor %}

                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/50">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-6 pt-2">
                    <div class="w-full md:w-1/3">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold uppercase tracking-wider text-white/70">Price Range</label>
                            <span class="text-xs font-bold text-primary" id="price-display">Any Price</span>
                        </div>
                        <input type="hidden" name="max_price" id="hidden-max-price" value="{{ max_price|default:'' }}">
                        <!-- Standard logic: 0 (Left) = Min. 100 (Right) = Max/Any. -->
                        <input class="w-full h-2 rounded-full cursor-pointer range-slider" id="price-range" max="100"
                            min="0" step="0.1" type="range" value="0" data-initial-price="{{ max_price|default:'' }}" />
                        <style>
                            .range-slider {
                                -webkit-appearance: none;
                                appearance: none;
                                height: 8px;
                                border-radius: 4px;
                                background: rgba(255, 255, 255, 0.1);
                                outline: none;
                            }

                            .range-slider::-webkit-slider-thumb {
                                -webkit-appearance: none;
                                appearance: none;
                                width: 18px;
                                height: 18px;
                                border-radius: 50%;
                                background: var(--color-primary);
                                cursor: pointer;
                                border: 2px solid white;
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                                margin-top: -5px;
                            }

                            .range-slider::-moz-range-thumb {
                                width: 18px;
                                height: 18px;
                                border-radius: 50%;
                                background: var(--color-primary);
                                cursor: pointer;
                                border: 2px solid white;
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                            }

                            .range-slider::-webkit-slider-runnable-track {
                                height: 8px;
                                border-radius: 4px;
                            }

                            .range-slider::-moz-range-track {
                                height: 8px;
                                border-radius: 4px;
                                background: rgba(255, 255, 255, 0.1);
                            }
                        </style>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const slider = document.getElementById('price-range');
                                const priceDisplay = document.getElementById('price-display');
                                const hiddenInput = document.getElementById('hidden-max-price');

                                if (slider) {
                                    function formatPrice(value) {
                                        if (value >= 10000000) {
                                            return '₹' + (value / 10000000).toFixed(1) + ' Cr';
                                        } else if (value >= 100000) {
                                            return '₹' + (value / 100000).toFixed(1) + ' L';
                                        }
                                        return '₹' + value.toLocaleString('en-IN');
                                    }

                                    function updateSlider() {
                                        // Internal limits (Real Prices)
                                        const priceMin = 1000000;
                                        const priceMax = 100000000;

                                        const sliderVal = parseFloat(slider.value); // 0 to 100 scale
                                        const percentage = sliderVal;

                                        // Visual update: Fill from left
                                        slider.style.background = `linear-gradient(to right, var(--color-primary) 0%, var(--color-primary) ${percentage}%, rgba(255,255,255,0.1) ${percentage}%, rgba(255,255,255,0.1) 100%)`;

                                        // Logic: 0 (Left) = Any Price. >0 = Specific Limit (Min -> Max).
                                        let computedLimit;

                                        if (sliderVal <= 0) { // Threshold for "Any" at start
                                            computedLimit = null; // No limit
                                        } else {
                                            // Linear interpolation
                                            computedLimit = priceMin + ((sliderVal / 100) * (priceMax - priceMin));
                                        }

                                        // Update price display
                                        if (priceDisplay) {
                                            if (computedLimit === null) {
                                                priceDisplay.textContent = 'Any Price';
                                                if (hiddenInput) hiddenInput.value = '';
                                            } else {
                                                // Round to sensible numbers
                                                priceDisplay.textContent = formatPrice(priceMin) + ' - ' + formatPrice(computedLimit);
                                                if (hiddenInput) hiddenInput.value = Math.round(computedLimit);
                                            }
                                        }
                                    }

                                    // Initialize slider position from hidden value if present
                                    const initialPrice = slider.dataset.initialPrice;
                                    if (initialPrice && initialPrice !== '') {
                                        const priceMin = 1000000;
                                        const priceMax = 100000000;
                                        const p = parseFloat(initialPrice);

                                        // percent = ((p - Min) / (Max - Min)) * 100
                                        let percent = ((p - priceMin) / (priceMax - priceMin)) * 100;

                                        if (percent < 0) percent = 0;
                                        if (percent > 100) percent = 100;
                                        slider.value = percent;
                                    } else {
                                        slider.value = 0;
                                    }

                                    slider.addEventListener('input', updateSlider);
                                    updateSlider(); // Initial call
                                }
                            });
                        </script>
                    </div>
                    <div class="w-full md:w-2/3 flex justify-end gap-3">
                        <a href="{% url 'all_cars' %}"
                            class="w-full md:w-auto  hover:border-white/40 transition-all text-white font-bold text-sm tracking-widest flex items-center justify-center gap-2 cursor-pointer">
                            <span class="material-symbols-outlined text-lg">filter_alt_off</span>
                            Clear Filters
                        </a>
                        <button type="submit"
                            class="w-full md:w-auto px-8 py-2.5 rounded-lg bg-primary hover:bg-primary/90 transition-all text-white font-bold text-sm tracking-widest shadow-lg shadow-primary/20 flex items-center justify-center gap-2 cursor-pointer">
                            <span class="material-symbols-outlined text-lg">search</span>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
            {% for i in all_cars %}

            <div
                class="car-card-glass rounded-xl overflow-hidden group flex flex-col h-full border border-white/10 hover:border-primary/30 transition-colors">
                <div class="relative h-64 overflow-hidden">
                    <img alt="{{i.brand}} {{i.model}}"
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                        src="{{i.featured_image.url}}" />
                    <div class="absolute top-3 left-3">
                        {% if i.is_available %}
                        <span
                            class="bg-primary text-white text-[8px] font-bold px-2 py-0.5 rounded-full uppercase tracking-widest shadow-xl">For
                            Sale</span>
                        {% else %}
                        <span
                            class="bg-red-600 text-white text-[8px] font-bold px-2 py-0.5 rounded-full uppercase tracking-widest shadow-xl">Sold</span>
                        {% endif %}
                    </div>
                    <button
                        class="absolute bottom-4 right-4 w-10 h-10  flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0">

                    </button>
                </div>
                <div class="p-6 flex flex-col flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <div class="">
                            <div class="text-primary text-[10px] font-bold tracking-widest uppercase mb-4">{{i.year}}
                            </div>
                            <h3 class="text-white text-lg font-bold uppercase tracking-wide">{{i.brand}} {{i.model}}
                            </h3>
                        </div>
                        <span class="text-white font-bold text-lg">₹{{i.price|floatformat:0|intcomma}}</span>
                    </div>

                    <div class="grid grid-cols-3 gap-2 border-t border-white/5 pt-4 mt-auto mb-4">
                        <div class="flex flex-col items-center gap-1">
                            <span class="material-symbols-outlined text-white/30 text-base">directions_car</span>
                            <span class="text-white text-xs font-bold uppercase">{{i.type}}</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 border-l border-white/5">
                            <span class="material-symbols-outlined text-white/30 text-base">verified</span>
                            <span class="text-white text-xs font-bold uppercase">{{i.condition}}</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 border-l border-white/5">
                            <span class="material-symbols-outlined text-white/30 text-base">local_gas_station</span>
                            <span class="text-white text-xs font-bold uppercase">{{i.fuel}}</span>
                        </div>
                    </div>
                    <a href="{% url 'cars' i.id %}"
                        class="w-full text-center py-2.5 rounded-lg border border-white/10 text-white text-[9px] font-bold uppercase tracking-[0.2em] group-hover:bg-primary group-hover:border-primary transition-all mt-auto flex items-center justify-center gap-2">
                        View Details
                    </a>
                </div>
            </div>

            {% endfor %}

        </div>
        <div class="flex flex-col items-center gap-6">
            <p class="text-white/40 text-xs font-medium uppercase tracking-widest">
                Page {{ all_cars.number }} of {{ all_cars.paginator.num_pages }}
                ({{ all_cars.paginator.count }} Vehicles)
            </p>

            <!-- Pagination Controls -->
            <div class="flex items-center gap-2">
                <!-- Previous Button -->
                {% if all_cars.has_previous %}
                <a href="?page={{ all_cars.previous_page_number }}"
                    class="w-10 h-10 rounded-lg border border-white/10 bg-white/5 hover:bg-primary hover:border-primary text-white flex items-center justify-center transition-all">
                    <span class="material-symbols-outlined text-lg">chevron_left</span>
                </a>
                {% else %}
                <span
                    class="w-10 h-10 rounded-lg border border-white/5 bg-white/5 text-white/30 flex items-center justify-center cursor-not-allowed">
                    <span class="material-symbols-outlined text-lg">chevron_left</span>
                </span>
                {% endif %}

                <!-- Page Numbers -->
                <div class="flex items-center gap-1">
                    {% for num in all_cars.paginator.page_range %}
                    {% if all_cars.number == num %}
                    <span
                        class="w-10 h-10 rounded-lg bg-primary text-white text-sm font-bold flex items-center justify-center">
                        {{ num }}
                    </span>
                    {% elif num > all_cars.number|add:'-3' and num < all_cars.number|add:'3' %} <a
                        href="?page={{ num }}"
                        class="w-10 h-10 rounded-lg border border-white/10 bg-white/5 hover:bg-primary hover:border-primary text-white text-sm font-bold flex items-center justify-center transition-all">
                        {{ num }}
                        </a>
                        {% endif %}
                        {% endfor %}
                </div>

                <!-- Next Button -->
                {% if all_cars.has_next %}
                <a href="?page={{ all_cars.next_page_number }}"
                    class="w-10 h-10 rounded-lg border border-white/10 bg-white/5 hover:bg-primary hover:border-primary text-white flex items-center justify-center transition-all">
                    <span class="material-symbols-outlined text-lg">chevron_right</span>
                </a>
                {% else %}
                <span
                    class="w-10 h-10 rounded-lg border border-white/5 bg-white/5 text-white/30 flex items-center justify-center cursor-not-allowed">
                    <span class="material-symbols-outlined text-lg">chevron_right</span>
                </span>
                {% endif %}
            </div>
        </div>
    </div>
</main>
<div class="lg:hidden fixed bottom-8 left-1/2 -translate-x-1/2 z-30">
    <button
        class="flex items-center justify-center w-14 h-14 bg-primary text-white rounded-full shadow-2xl shadow-primary/60 active:scale-90 transition-transform cursor-pointer"
        onclick="toggleSearchModal()" aria-label="Open search">
        <span class="material-symbols-outlined text-2xl">search</span>
    </button>
</div>
<div class="hidden fixed inset-0 z-[100] flex-col bg-background-dark/98 backdrop-blur-2xl transition-all duration-300 overflow-y-auto"
    id="search-modal">
    <div class="p-6 flex flex-col min-h-full">
        <div class="flex justify-end mb-12">
            <button class="text-white/60 hover:text-white cursor-pointer p-2" onclick="toggleSearchModal()"
                aria-label="Close search">
                <span class="material-symbols-outlined text-4xl">close</span>
            </button>
        </div>
        <div class="text-center mb-10">
            <h3 class="text-white text-3xl font-bold uppercase tracking-widest">Find Your Match</h3>
            <p class="text-white/40 text-sm mt-2">Filter our luxury inventory</p>
        </div>
        <form class="flex flex-col gap-6 max-w-md mx-auto w-full">
            <div class="space-y-6">
                <div class="border-b border-white/10 pb-4">
                    <label
                        class="flex items-center gap-3 text-[10px] font-bold text-white/50 uppercase tracking-widest mb-3">
                        <span class="material-symbols-outlined text-base">directions_car</span> Model
                    </label>
                    <select
                        class="w-full bg-transparent border-none p-0 text-white text-xl font-medium focus:ring-0 appearance-none">
                        <option class="text-black" value="">Select Model</option>
                        <option class="text-black" value="model-s">Model S Plaid</option>
                        <option class="text-black" value="taycan">Porsche Taycan</option>
                    </select>
                </div>
                <div class="border-b border-white/10 pb-4">
                    <label
                        class="flex items-center gap-3 text-[10px] font-bold text-white/50 uppercase tracking-widest mb-3">
                        <span class="material-symbols-outlined text-base">location_on</span> Location
                    </label>
                    <select
                        class="w-full bg-transparent border-none p-0 text-white text-xl font-medium focus:ring-0 appearance-none">
                        <option class="text-black" value="">All Locations</option>
                        <option class="text-black" value="ny">New York, NY</option>
                    </select>
                </div>
                <div class="border-b border-white/10 pb-4">
                    <label
                        class="flex items-center gap-3 text-[10px] font-bold text-white/50 uppercase tracking-widest mb-3">
                        <span class="material-symbols-outlined text-base">attach_money</span> Price Range
                    </label>
                    <select
                        class="w-full bg-transparent border-none p-0 text-white text-xl font-medium focus:ring-0 appearance-none">
                        <option class="text-black" value="">Max Price</option>
                        <option class="text-black" value="100k">$100,000</option>
                    </select>
                </div>
            </div>
            <button
                class="mt-8 flex w-full h-16 cursor-pointer items-center justify-center rounded-xl bg-primary hover:bg-primary/90 transition-all text-white shadow-xl shadow-primary/30"
                type="button">
                <span class="text-sm font-bold uppercase tracking-widest">Find Vehicle</span>
            </button>
        </form>
    </div>
</div>
{% endblock %}